/**
 * Copyright (C) 2022 Anh Huy Ngo - All Rights Reserved
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * 
 * Author: Anh Ngo
 * Created Date: 
 */


 'use strict';
 
 

////////////////////////////////////////////////////////////////////
// MODULE LOADING
////////////////////////////////////////////////////////////////////
const WORKER = require('worker_threads');



////////////////////////////////////////////////////////////////////
// FUNCTION
////////////////////////////////////////////////////////////////////

function isDebug(){
    return require("./config").Config.DEBUG;
}

function log(type, tag, msg, tofile=false){
    
    console.log(`${type} ${(new Date().toISOString())} ${process.pid} ${WORKER.threadId} ${tag} : ${msg}`);
    // console.log(type + " " + (new Date().toISOString()) + " " + tag + ": " + msg);
};
function logE(type, tag, msg, tofile=false){
    // console.error(type + " " + (new Date().toISOString()) + " " + tag + ": " + msg);
    console.error(`${type} ${(new Date().toISOString())} ${process.pid} ${WORKER.threadId} ${tag} : ${msg}`);
};

function Log(tag){
    this.tag = tag;
}

// print object directly. using literal like `` not work, as it assumes object is string/primary type
Log.prototype.raw = function(msg, prefix = null, tofile=false){
    if (isDebug()){
        if (prefix != null){
            this.d(prefix);
        }
        console.log(msg);
    }
        
}


Log.prototype.i = function(msg, tofile=false){
    log("I", this.tag, msg, tofile);
}


Log.prototype.d = function(msg){
    if (isDebug()){
        log("D", this.tag, msg);
    }
}

Log.prototype.e = function(msg, tofile=false){
    logE("E", this.tag, msg, tofile);
}

function isEmpty(str){
    return (!str || str.length === 0 || (str === undefined))
}
function isDictEmpty(dict) {
    return (!dict || (Object.keys(dict).length === 0) || (dict === undefined));
}

Log.prototype.dumpArray = function(arr, msg="", separater='|'){
    this.d("dumpArray below ...");
    if (isEmpty(arr)){
        this.d(`${msg}: empty`);
    }
    else{
        var arrstr = "";
        arr.forEach(element => {
            arrstr += `${element} ${separater}`;
        });
        this.d(`${msg}: ${arrstr}`);
    }
}

Log.prototype.dumpDict = function(dict, msg="", separater=' ', getString=null){
    this.d("dumpDict below ...");
    if (isDictEmpty(dict)){
        this.d(`${msg}: empty`);
    }
    else{
        var arrstr = "";
        
        for (const [key, values] of Object.entries(dict)) {
            
            arrstr += `\n${key} => `;
            var elestr = "";
            if (Array.isArray(values)){
                values.forEach(element => {

                    if (getString){
                        elestr = getString(element);
                    }
                    else{
                        elestr = element;
                    }
                    arrstr += `${elestr} ${separater}`;
                });
            }
            else{
                if (getString){
                    elestr = getString(values);
                }
                else{
                    elestr = values;
                }
                arrstr += `${elestr} ${separater}`;
            }
            
          }

    
          
        this.d(`${msg}: ${arrstr}`);
    }
}


////////////////////////////////////////////////////////////////////
// MODULE EXPORT
////////////////////////////////////////////////////////////////////

exports.build = function(tag){
    return new Log(tag);
}