/**
 * Copyright (C) 2022 Anh Huy Ngo - All Rights Reserved
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * 
 * Author: Anh Ngo
 * Created Date: 
 */

////////////////////////////////////////////////////////////////////
// MODULE LOADING
////////////////////////////////////////////////////////////////////

var ERR = require("../errno");
var COMMON = require("../common");
var CONFIG = require("../config");
var MODULE_CTRL = require("./module_ctrl");
var CVE = require("../model/cve/cve_db");
var CVE_MODULE_DB = require("../model/cve/cve_module_db");
var PRJ_MODULE_DB = require("../model/project/project_module_db");
var PRJ_CVE_DB = require("../model/project/project_cve_db");

var PATH = require('path');
var FS = require('fs');

const {
    Worker
  } = require('worker_threads');
////////////////////////////////////////////////////////////////////
// GLOBAL VARIABLES
////////////////////////////////////////////////////////////////////

/**
 * Logging object
 */
var log = require("../log").build("cve_ctrl");

////////////////////////////////////////////////////////////////////
// FUNCTION
////////////////////////////////////////////////////////////////////

/**
 * Add CVE to db
 * @param {*} cveitem CVE Item object
 * @returns 
 */
function addCVE(cveitem){
    log.d(`add CVE ${cveitem.toString()}`);
    return new Promise((resolve, reject) => {
        CVE.add(cveitem)
            .then((item) => {
                log.d(`Added cve ${cveitem.vul_id} done, add module-cve mapping list`);
                return MODULE_CTRL.parseToGetModuleList(item.getDesc());
            })
            .then(moduleList => {
                log.dumpArray(moduleList, "moduleList");
                if (!COMMON.isEmpty(moduleList)){
                    log.dumpArray(moduleList, "module list");
                    var requests = moduleList.map(element => {
                        log.d(`map cve id ${cveitem.id} and ${element}`);
                        return CVE_MODULE_DB.add(cveitem.id, element, []);
                    })
                    return new Promise((resolve2, reject2) => Promise.all(requests).then(resolve2(moduleList)));
                }
                else{
                    log.i(`Not found any module list for cve ${cveitem.vul_id} `);
                    resolve(cveitem);
                }
            })
            .then(function(moduleList){
                log.d("Added all mapping, check project");
                log.dumpArray(moduleList, "module list");
                var projectList = [];
                let requests = moduleList.map(moduleid=>{
                    return new Promise((resolve3, reject3) => {
                        PRJ_MODULE_DB.getProjectListOfModule(moduleid)
                            .then(prjlist => {
                                log.dumpArray(prjlist, "prjlist");
                                prjlist.forEach(prj => {
                                    if (!projectList.includes(prj.projectId)){
                                        projectList.push(prj.projectId);
                                    }
                                })
                                resolve3(projectList);
                                // projectList.push.apply(projectList, prjlist);
                            })
                            ;
                    }) 
                });

                return new Promise((resolve4, reject4) => Promise.all(requests)
                        .then(function(){
                            log.dumpArray(projectList, "ALL projectList");
                            resolve4(projectList)}
                        ));
                
                // resolve(cveitem);
            })
            .then(function(projectList){
                log.dumpArray(projectList, "get all project list callback");
                let requests = projectList.map(prjid => {
                    log.d(`Add map for prj ${prjid} - cve ${cveitem.id}`);
                    return PRJ_CVE_DB.add(prjid, cveitem.id);
                });
                // resolve(cveitem);
                Promise.all(requests).then(function(){
                    // log.dumpArray(projectList, "get all project list callback");
                    log.d(`Added all mapping prj-cve for cve ${cveitem.id} - ${cveitem.vul_id}`);
                    
                    resolve(cveitem);
                });
            })
            .catch(err => {
                if (err instanceof ERR.ValError){
                    log.e(`Add cve ${cveitem.vul_id} failed with ValErr`);
                    // var [msg, code] = COMMON.parseError(err);
                    reject(err);
                }
                else{
                    var retmsg = `Add cve ${cveitem.vul_id} failed, ${err}`;
                    log.e(retmsg);
                    reject(COMMON.buildError(retmsg, ERR.ErrFailed, cveitem, err));
                }
            });
    });
}

function getCVEList(keyword, page, perpage){
    log.d(`getCVEList, '${keyword}', ${page}, ${perpage}`);
    return new Promise((resolve, reject) => {
        CVE.search(keyword, page, perpage)
            .then(function(result){
                var cves = result.cves;
                var totalpages = result.totalpages;
                log.d(`search callback, totalpages ${totalpages}`);
                if (!COMMON.isEmpty(cves)){
                    // var allModuleList = []
                    let requests = cves.map(cve => {
                        return new Promise((resolve2, reject2) => {
                            log.d(`Get module list for cve ${cve.id} (${cve.vul_id})`);
                            CVE_MODULE_DB.getModuleListOfCVE(cve.id)
                                .then(moduleList => 
                                    {
                                        log.d("Get module list callback");
                                        log.dumpArray(moduleList, `Module list of ${cve.cve_id}`);
                                        cve.modules = moduleList;
                                        // moduleList.forEach(element => {
                                        //     if (!allModuleList.includes(element.moduleId)){
                                        //         allModuleList.push(element.moduleId);
                                        //     }
                                        // })
                                        resolve2(cve);
                                    });
                        });
                    });

                    return new Promise ((resolve3, reject3) => {
                        Promise.all(requests)
                        .then(function(){
                            // log.dumpArray(allModuleList, "Got all module list callback");
                            resolve3(result);
                        })
                        .catch(err => {
                            log.e(`Got module list of cve failed ${err}`);
                        })
                        ;
                    });
                }
                else{
                    resolve(result);
                }
                
            })
            .then(result => {
                var cves = result.cves;
                let requests = cves.map(cve => {
                    return new Promise((resolve4, reject4) => {
                        log.d(`Get prj list for cve ${cve.id} (${cve.vul_id})`);
                        PRJ_CVE_DB.getProjectListOfCve(cve.id)
                            .then(projectList => 
                                {
                                    log.d("Get prj list callback");
                                    log.dumpArray(projectList, `Prj list of ${cve.cve_id}`);
                                    cve.projects = projectList;
                                    resolve4(cve);
                                });
                    });
                });
                Promise.all(requests)
                        .then(function(){
                            // log.dumpArray(allModuleList, "Got all module list callback");
                            resolve(result);
                        })
                        .catch(err => {
                            log.e(`Got Prj list of cve failed ${err}`);
                        })
                        ;

            })
            ;
    });
}


function getCVE(id, callback){
    log.d(`getCVE, '${id}'`);
    CVE.getByAnyId(id)
            .then(function(cveItem){
                log.d(`Get cve ok, ${cveItem.toString()}`);
                return new Promise ((resolve2, reject2) => { 
                    CVE_MODULE_DB.getModuleListOfCVE(cveItem.id)
                        .then(moduleList => 
                            {
                                log.d("Get module list callback");
                                log.dumpArray(moduleList, `Module list of ${cveItem.cve_id}`);
                                cveItem.modules = moduleList;
                                resolve2(cveItem);
                            })
                            .catch((err)=>{
                                log.e(`Get module list of cve ${id} failed" ${err}`);
                                callback(ERR.ErrFailed, err);
                            });
                    });
                
            })
            .then(cveItem => {
                PRJ_CVE_DB.getProjectListOfCve(cveItem.id)
                    .then(projectList => 
                        {
                            log.d("Get prj list callback");
                            log.dumpArray(projectList, `Prj list of ${cveItem.cve_id}`);
                            cveItem.projects = projectList;
                            callback(ERR.ErrNone, cveItem);
                        })
                        .catch((err)=>{
                            log.e(`Get prj list of cve ${id} failed" ${err}`);
                            callback(ERR.ErrFailed, err);
                        });
            })
            .catch((err)=>{
                log.e(`Get cve ${id} failed" ${err}`);
                callback(ERR.ErrFailed, err);
            });
}


////////////////////////////////////////////////////////////////////
// MODULE EXPORT
////////////////////////////////////////////////////////////////////
exports.addCVE = addCVE;
exports.getCVEList = getCVEList;
exports.getCVE = getCVE;