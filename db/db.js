/**
 * Copyright (C) 2022 Anh Huy Ngo - All Rights Reserved
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * 
 * Author: Anh Ngo
 * Created Date: 
 */
////////////////////////////////////////////////////////////////////
// MODULE LOADING
////////////////////////////////////////////////////////////////////

var ERR = require("../errno");
var COMMON = require("../common");
var CONFIG = require("../config").Config;
var MONGO = require('mongoose');


////////////////////////////////////////////////////////////////////
// GLOBAL VARIABLES
////////////////////////////////////////////////////////////////////


var log = require("../log").build("db");

var dbString = CONFIG.getDbString();

const STATUS_ERR = -2;
const STATUS_DELETED = -1;
const STATUS_INACTIVE = 0;
const STATUS_ACTIVE = 1;
const STATUS_ONHOLD = 2;


////////////////////////////////////////////////////////////////////
// FUNCTION
////////////////////////////////////////////////////////////////////

/**
 * Init database
 */
function initDB(){
    log.i(`Init DB, URL ${dbString}`);
    // connect(null);
}

/** 
 * Connect to database
 * @param callback (error, cb)
 * @returns error code. If ErrNone, return result via callback
 */
function connect(callback){
    log.i(`connect db ${dbString}`);
    if (callback){
        log.i("Connect db, return via calllback");
        MONGO.connect(dbString, function(err, db){
            log.i("Mongo connect callback");
            if (err) {
                log.e(`Mongo connect error ${err}`);
                // throw err;
            }
            else{
                log.i("Database created!");
            }
            if (callback){
                log.d("Call back after connect db");
                callback(err, db);
            }
            else{
                log.d("No callback to call")
            }
            // db.close();
        });
    }
    else{
        log.i("Connect db, sync");
        MONGO.connect(dbString);
    }
    log.d("end of connect");
    return ERR.ErrNone;
}

////////////////////////////////////////////////////////////////////
// MODULE EXPORT
////////////////////////////////////////////////////////////////////

exports.initDB = initDB;
exports.connectdb = connect;
exports.connectdbsync = connect;

exports.STATUS_ERR = STATUS_ERR;
exports.STATUS_DELETED = STATUS_DELETED;
exports.STATUS_INACTIVE = STATUS_INACTIVE;
exports.STATUS_ACTIVE = STATUS_ACTIVE;
exports.STATUS_ONHOLD = STATUS_ONHOLD;