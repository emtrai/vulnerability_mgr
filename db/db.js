var errno = require("../errno");
var ModComm = require("../common");
var ModConf = require("../config").Config;
var log = require("../log").build("db");
var ModMongo = require('mongoose');

var dbString = ModConf.getDbString();

/**
 * Init database
 */
function initDB(){
    log.i(`Init DB, URL ${dbString}`);
    // connect(null);
}

/** 
 * Connect to database
 * @param callback (error, cb)
 * @returns error code. If ErrNone, return result via callback
 */
function connect(callback){
    log.i(`connect db ${dbString}`);
    if (callback){
        log.i("Connect db, return via calllback");
        ModMongo.connect(dbString, function(err, db){
            log.i("Mongo connect callback");
            if (err) {
                log.e(`Mongo connect error ${err}`);
                // throw err;
            }
            else{
                log.i("Database created!");
            }
            if (callback){
                log.d("Call back after connect db");
                callback(err, db);
            }
            else{
                log.d("No callback to call")
            }
            // db.close();
        });
    }
    else{
        log.i("Connect db, sync");
        ModMongo.connect(dbString);
    }
    log.d("end of connect");
    return errno.ErrNone;
}

exports.initDB = initDB;
exports.connectdb = connect;
exports.connectdbsync = connect;