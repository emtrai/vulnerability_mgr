
const PARAM_PAGE = 'page';
const PARAM_PERPAGE = 'perpage';
const PARAM_SEARCH_KEY = 'key';
const PARAM_SEARCH_IN = 'in';
const PARAM_FILTER_PRJ = 'prj';
const PARAM_FILTER_COMP = 'comp';
const PARAM_FILTER_MODULE = 'mod';
const PARAM_FILTER_MARKET = 'mrk';
const PARAM_FILTER_SRC = 'src';
const PARAM_FILTER_TAG = 'tag';
var paramlist=[
    PARAM_PAGE
    ,PARAM_PERPAGE
    ,PARAM_SEARCH_KEY
    ,PARAM_SEARCH_IN
    ,PARAM_FILTER_PRJ
    ,PARAM_FILTER_COMP
    ,PARAM_FILTER_COMP
    ,PARAM_FILTER_MODULE
    ,PARAM_FILTER_MARKET
    ,PARAM_FILTER_SRC
    ,PARAM_FILTER_TAG
];



function showHide(divid, hide){
    var div = document.getElementById(divid);
    if (div != null){
        div.style.display = hide?"none":"block";
    }
}
function showHideToggle(divid){
    var div = document.getElementById(divid);
    if (div != null){
        
        div.style.display = div.style.display=="block"?"none":"block";
    }
}

function doFilter(){
    var param = {
        "key":"any"
    };
    var url = queryCVE(param);
    if (url != null){

        window.history.pushState(param,"", url);
    }
}

function onLoadCVE(data, status, xhdr){
    var tbl = document.getElementById('tblCVE');
    var divPage = document.getElementById('divPage');
    var rowCount = tbl.rows.length;
	var cellCount = tbl.rows[0].cells.length; 
    if (data != null){
        // $.each
        divPage.innerHTML = `${data.page}/${data.totalpages}`;
    }
    $.each( data.cves, function( index, value ) {
        log(`${index}: ${value.desc}`);
        var row = tbl.insertRow(rowCount++);
        var cellidx = 0;
        row.insertCell(cellidx++).innerHTML = value.idx;
        row.insertCell(cellidx++).innerHTML = value.cve_id;
        row.insertCell(cellidx++).innerHTML = value.desc;
        row.insertCell(cellidx++).innerHTML = value.source;
        row.insertCell(cellidx++).innerHTML = value.ref;
        row.insertCell(cellidx++).innerHTML = value.tag;
      });
    showHide('divFilter', true);
	// var row = tbl.insertRow(rowCount);
}

// function queryCVE(filter, search){
//     log("QueryCVE");
//     var param = "";
//     if ((filter != null) && (filter.length != 0)){
//         param += `filter=${filter}`;
//     }

//     if ((search != null) && (search.length != 0)){
//         if (param.length != 0){
//             param += "&";
//         }
//         param += `search=${search}`;
//     }
//     $.ajax(`list?${param}`, {
//         dataType:'json',
//         type:'POST',
//         success:onLoadCVE
//     })
// }

function queryCVE(paramdic){
    log("QueryCVE");
    var param = "";
    $.each(paramdic, function(key, value){
        if (param.length != 0){
            param += "&";
        }
        param += `${key}=${value}`;
    });
    // Array.from(paramdic.entries()).map(function(key, val)
    //     {       
    //         if (param.length != 0){
    //             param += "&";
    //         }
    //         param += `${key}=${value}`;
    //     }
    // );

    // paramdic.forEach(function(key, value){
    //     if (param.length != 0){
    //         param += "&";
    //     }
    //     param += `${key}=${value}`;
    // });
    // if ((filter != null) && (filter.length != 0)){
    //     param += `filter=${filter}`;
    // }

    // if ((search != null) && (search.length != 0)){
        
    //     param += `search=${search}`;
    // }
    if (param.length > 0){

        var url = `/list?${param}`;
        $.ajax(url, {
            dataType:'json',
            type:'POST',
            success:onLoadCVE
        })
        return url;
    }
    
    return null;
}


jQuery(function(){
    var url = new URL(window.location.href);

    var param = {};
    paramlist.forEach(function(element){
        var value = url.searchParams.get(element);
        if ((value != undefined) && (value != null) && (value.length != 0)){
            param[element] = value;
            queryCVE(param);
        }
    });

    
    // var filter = url.searchParams.get('filter');
    // if ((search != null) || (filter != null)){
    //     queryCVE(filter, search);
    // }
    // console.log(url.href);
    // console.log(url.search);
})

window.onpopstate = function(event){
    if ((event.state != null) && (event.state != undefined)){
        queryCVE(event.state);
        // var search = null;
        // var filter = null;
        // if ((event.state.search != null) && (event.state.search != undefined)){
        //     search = event.state.search;
        // }
        // if ((event.state.filter != null) && (event.state.filter != undefined)){
        //     filter = event.state.filter;
        // }
        // if ((search != null) || (filter != null)){
        //     queryCVE(filter, search);
        // }
    }
};
