

// var ModNist = require('../import/nist')
var log = require('../log').build("importcve");
var CVE_CTRL = require('../controller/cve_ctrl');

var CVE_IMPORT_CTRL = require("../controller/cve_import_ctrl");
var APP = require("../app");

var ERR = require("../errno");
var COMMON = require("../common");

const PARAM_REQ = 'req';
const PARAM_ID = 'id';
const PARAM_DOWNLOAD = 'download';

const PARAM_DOWNLOAD_VUL_INFO = 'vulinfo';

const SOURCE_LIST = {
    [CVE_IMPORT_CTRL.IMPORT_NIST]: "Nist - json"
}
const FORMIDABLE = require('formidable');

var PROJECT_CTRL = require("../controller/project_ctrl");
var MODULE_CTRL = require("../controller/module_ctrl");



module.exports.handleReq = function(req, res, next){
    log.d("handle get req");
    log.d("render")
    var reqId = null;
    var download = null;
    if (req.query.hasOwnProperty(PARAM_ID)){
        reqId = req.query[PARAM_ID];
    }
    if (req.query.hasOwnProperty(PARAM_DOWNLOAD)){
        download = req.query[PARAM_DOWNLOAD];
    }

    if (reqId){
        CVE_IMPORT_CTRL.getImportInfo(reqId, function(retCode, importItem){
            if (retCode == ERR.ErrNone){
                var item = CVE_IMPORT_CTRL.buildImportReq();
                item.id = importItem.importId;
                item.workingDir = importItem.workingDir;
                CVE_IMPORT_CTRL.readImportSummarize(item, function(retCode, data){
                    var summarize = "";
                    if (retCode == ERR.ErrNone){
                        summarize = data;
                    }
                    else{
                        summarize = "Read summarize file failed";
                    }

                    res.render('importinfo', {
                        importId:importItem.importId,
                        source:importItem.source,
                        createDate:COMMON.getTimeString(importItem.createDate),
                        workingDir:importItem.workingDir,
                        importStatus:importItem.importStatus,
                        summarize:summarize
                    });
                })
                
            }
            else{

            }
        })
        
    }
    else{
        var projects = [];
        var modules = [];
        new Promise((resolve, reject)=>{
            PROJECT_CTRL.getListProjects(function(retCode, items){
                resolve(items);
            });
        })
        .then(items => {
            items.forEach(element => projects.push(element));
            return MODULE_CTRL.getList();
        })
        .then(items => {
            items.forEach(element => modules.push(element));
            res.render('importcve', {
                sources:Object.keys(SOURCE_LIST).map(key=>{
                    return {
                        id:key,
                        name:SOURCE_LIST[key]
                    }
                }),
                projects:projects.map(function(item){
                    return {
                        id:item.id,
                        name:item.name
                    }
                }),

                modules:modules.map(function(item){
                    return {
                        id:item.id,
                        name:item.name
                    }
                })
            });
        })
        ;
        

        
    }

}


module.exports.handlePost = function(req, res, next){
    log.d("handle post req");
    log.d("upload file");
    var reqId = null;
    if (req.query.hasOwnProperty(PARAM_REQ)){
        log.d(`Try to get req id from param ${PARAM_REQ}`);
        // log.dumpDict(req.query);
        // console.log(req);
        reqId = req.query[PARAM_REQ];
    }

    log.d(`reqId ${reqId}`);
    if ((reqId == null) || (reqId == undefined)){
        // APP.uploadfile(req,res, 'cve', function(err) {
        //     if(err) {
        //         var ret_msg = `Error uploading file: ${err}`;
        //         log.e(ret_msg);
        //         return APP.responseMsg(res, ERR.ErrFailed, ret_msg);
        //         // return res.end("Error uploading file.");
        //     }
        //     log.i(`Upload file ok, filepath ${res.req.file.path}`);
        //     // res.status(200).json({success:"analyzing"});
        //     // ModNist.parse(res.req.file.path);
        //     const form = FORMIDABLE({ multiples: true });
        //     form.parse(req, (err, fields, files) => {
        //         console.log('fields: ', fields);
        //         console.log('files: ', files);

        //         log.d(`Start import CVE`);
        //         var importReq = CVE_IMPORT_CTRL.importCve(res.req.file.path, "nist", function(ireq){
        //             log.d(`Import cve callback`);
        //         });

        //         log.d(`Response import request ${CVE_IMPORT_CTRL.importReqString(importReq)}`);
        //         res.json({
        //             reqId:importReq.id,
        //             status:importReq.state,
        //         })
        //     });
        // });

        // const form = FORMIDABLE({ multiples: true });
        // form.parse(req, (err, fields, files) => {
        //     console.log('fields: ', fields);
        //     console.log('files: ', files);
        //     APP.uploadfile(req,res, 'cve', function(err) {
        //         if(err) {
        //             var ret_msg = `Error uploading file: ${err}`;
        //             log.e(ret_msg);
        //             return APP.responseMsg(res, ERR.ErrFailed, ret_msg);
        //             // return res.end("Error uploading file.");
        //         }
        //         console.log(res.req);
        //         log.i(`Upload file ok, filepath ${res.req.file.path}`);
        //         // res.status(200).json({success:"analyzing"});
        //         // ModNist.parse(res.req.file.path);
        //         var importReq = CVE_IMPORT_CTRL.importCve(res.req.file.path, "nist", function(ireq){
        //             log.d(`Import cve callback`);
        //         });

        //         log.d(`Response import request ${CVE_IMPORT_CTRL.importReqString(importReq)}`);
        //         res.json({
        //             reqId:importReq.id,
        //             status:importReq.state,
        //         })
        //     });
        // });
        APP.uploadfile(req,res, 'cve', function(err) {
            if(err) {
                var ret_msg = `Error uploading file: ${err}`;
                log.e(ret_msg);
                return APP.responseMsg(res, ERR.ErrFailed, ret_msg);
                // return res.end("Error uploading file.");
            }
            console.log(res.req.body);
            log.i(`Upload file ok, filepath ${res.req.file.path}`);
            // res.status(200).json({success:"analyzing"});
            // ModNist.parse(res.req.file.path);
            var importReq = CVE_IMPORT_CTRL.importCve(res.req.file.path, "nist", function(ireq){
                log.d(`Import cve callback`);
            });

            log.d(`Response import request ${CVE_IMPORT_CTRL.importReqString(importReq)}`);
            res.json({
                reqId:importReq.id,
                status:importReq.state,
            })
        });
        
    }
    else{
        var req = CVE_IMPORT_CTRL.getImportReq(reqId);
        if (req != null){
            log.d(`Req infor of import req ${reqId} ${CVE_IMPORT_CTRL.importReqString(req)}`);
            res.json({
                reqId:req.id,
                status:req.state,
                result:req.result,
            })
        }
        else{
            var retMsg = `Import Req id ${reqId} not found`;
            log.e(retMsg);
            APP.responseMsg(res, ERR.ErrNotFound, retMsg);
        }
    }
    
}

module.exports.ROUTE_NAME = "importcve"