/**
 * Copyright (C) 2022 Anh Huy Ngo - All Rights Reserved
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * 
 * Author: Anh Ngo
 * Created Date: 
 */

 'use strict';
////////////////////////////////////////////////////////////////////
// MODULE LOADING
////////////////////////////////////////////////////////////////////

var ERR = require("../errno");
var COMMON = require("../common");
var CVE_CTRL = require("../controller/cve_ctrl");
var APP = require("../app");
////////////////////////////////////////////////////////////////////
// GLOBAL VARIABLES
////////////////////////////////////////////////////////////////////

var log = require("../log").build("route_cve");


const PARAM_ID="id";
////////////////////////////////////////////////////////////////////
// FUNCTION
////////////////////////////////////////////////////////////////////

function handleReq(req, res, next){
    log.d("handleReq");
    var reqId = null;
    if (req.query.hasOwnProperty(PARAM_ID)){
        reqId = req.query[PARAM_ID];
    }
    if (reqId != null){
        CVE_CTRL.getCVE(reqId, function(retCode, data){
            if (retCode == ERR.ErrNone){
                var cve = data;
                res.render('cve', {
                    found:true,
                    id:cve.id,
                    vul_id:cve.vul_id,
                    cve_id:cve.cve_id,
                    importId:cve.importId,
                    desc:cve.getDesc(),
                    ref:cve.ref,
                    tag:cve.tag,
                    source:cve.source,
                    // modules:cve.modules,
                    // projects:cve.projects,
                    cve_publishedDate:cve.cve_publishedDate,
                    cve_lastModifiedDate:cve.cve_lastModifiedDate,
                    lastModified:COMMON.getTimeString(cve.last_modified_date),
                    addedDate:COMMON.getTimeString(cve.added_date),
                    history:cve.history,
                    impactScore:cve.impactScore,
                    baseScore:cve.baseScore,
                    severity:cve.severity,
                    vectorAttack:cve.vectorAttack,
                    vectorString:cve.vectorString,

                    modules:cve.modules.map(function(item){
                        return {
                            id:item.moduleId,
                            name:item.moduleName,
                            versions:item.moduleVersions,
                        }
                    }),
                    projects:cve.projects.map(function(item){
                        return {
                            id:item.projectId,
                            name:item.projectName,
                        }
                    }),
                   
                });
            }
            else{
                res.render('cve', {
                    found:false,
                    msg:data.message
                   
                });
                // APP.responseMsg(res, ERR.ErrInvalid, "Not found specified");
            }
        });
    }
    else{
        // APP.responseMsg(res, ERR.ErrInvalid, "No ID specified");

        res.render('cve', {
            found:false,
            msg:"No ID specified"
           
        });
    }
}

function handlePost(req, res, next){
    log.d("handlePost");
    var ret = ERR.ErrInvalid;
    var ret_msg = "Invalid input";
    if (action == "add"){
        
    }
    else{
        APP.responseMsg(res, ret, ret_msg);
    }
    
}

////////////////////////////////////////////////////////////////////
// MODULE EXPORT
////////////////////////////////////////////////////////////////////

module.exports.handleReq = handleReq;
module.exports.handlePost = handlePost;
module.exports.ROUTE_NAME = "cve";