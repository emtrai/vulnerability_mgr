/**
 * Copyright (C) 2022 Anh Huy Ngo - All Rights Reserved
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * 
 * Author: Anh Ngo
 * Created Date: 
 */
////////////////////////////////////////////////////////////////////
// MODULE LOADING
////////////////////////////////////////////////////////////////////

var ERR = require("../errno");
var TAGS = require("../controller/tags_ctrl");
var MODULE_CTRL = require("../controller/module_ctrl");

////////////////////////////////////////////////////////////////////
// GLOBAL VARIABLES
////////////////////////////////////////////////////////////////////

var log = require("../log").build("modules");


////////////////////////////////////////////////////////////////////
// FUNCTION
////////////////////////////////////////////////////////////////////

function handleReq(req, res, next){
    log.d("handleReq");
    var tags = TAGS.getModuleTags();
    res.render('editmodule', {
        tags:Object.keys(tags).map(function(key){
            return {
                id:key,
                name:tags[key]
            }
        }),
    });
}

function handlePost(req, res, next){
    log.d("handlePost");
    
    MODULE_CTRL.getList().then(items => {
        log.d("search callback");
        var idx = 0;
        var tags = TAGS.getModuleTags();
        TAGS.dumpTags(tags);
        res.json({
            startIdx:idx,
            tags:Object.keys(tags).map(function(key){
                return {
                    id:key,
                    name:tags[key]
                }
            }),
            modules:items.map(function(item){
                return {
                    idx:idx++,
                    id:item.id,
                    name:item.name,
                    nameid:item.nameid,
                    desc:item.desc,
                    // tag:item.getTag()
                    tags:item.tags,
                    versions:item.versions,
                }})                    
        });
    });
}

////////////////////////////////////////////////////////////////////
// MODULE EXPORT
////////////////////////////////////////////////////////////////////

module.exports.handleReq = handleReq;
module.exports.handlePost = handlePost;
module.exports.ROUTE_NAME = "modules";
