////////////////////////////////////////////////////////////////////
// MODULE LOADING
////////////////////////////////////////////////////////////////////

var ERR = require("../errno");
var TAGS = require("../controller/tags_ctrl");
const { markets } = require("../model/market");
var PROJECT_CTRL = require("../controller/project_ctrl");
var MODULE_CTRL = require("../controller/module_ctrl");

////////////////////////////////////////////////////////////////////
// GLOBAL VARIABLES
////////////////////////////////////////////////////////////////////

var log = require("../log").build("prj");


////////////////////////////////////////////////////////////////////
// FUNCTION
////////////////////////////////////////////////////////////////////

function handleReq(req, res, next){
    log.d("handleReq");
    var tags = TAGS.getTags();
    MODULE_CTRL.getList().then(items => {
        res.render('editprj', {
            tags:Object.keys(tags).map(function(key){
                return {
                    id:key,
                    name:tags[key]
                }
            }),
            modules:items.map(function(item){
                return {
                    id:item.id,
                    name:item.name,
                }
            }),
        });
    });
    // res.render('editprj', {
    //     tags:Object.keys(tags).map(function(key){
    //         return {
    //             id:key,
    //             name:tags[key]
    //         }
    //     }),
    // });
    // TAGS.getTags(function(ret, tags){
    //     res.render('editprj', {
    //         tags:Object.keys(tags).map(function(key){
    //             return {
    //                 id:key,
    //                 name:tags[key]
    //             }
    //         }),
    //     });
    // });
    // var tags = ["VN", "EU", "USA"];
    // PROJECT_CTRL.getListProjects(function(err, items){
    //     // Change render accoridng account type?
    //     var idx = (page - 1)*perpage + 1;
    //     res.render('editprj', {
    //         projects:items.map(function(item){
    //             return {
    //                 idx:idx++,
    //                 id:item.id,
    //                 name:item.name,
    //                 nameid:item.nameid,
    //                 desc:item.desc,
    //                 tag:item.getTag()
    //             }
    //         }),
    //         tags:tags,
    //     });
    // });
    // res.render('editprj', {
    //     tags:Object.keys(tags).map(function(key){
    //         return {
    //             id:key,
    //             name:tags[key]
    //         }
    //     }),
    // });
}

function handlePost(req, res, next){
    log.d("handlePost");
    
    // PROJECT_CTRL.getListProjects(function(err, items){
    PROJECT_CTRL.getListProjectsWithModule(function(err, items){
        log.d("search callback");
        var idx = 0;
        var tags = TAGS.getTags();
        TAGS.dumpTags(tags);
        res.json({
            startIdx:idx,
            tags:Object.keys(tags).map(function(key){
                return {
                    id:key,
                    name:tags[key]
                }
            }),
            projects:items.map(function(item){
                return {
                    idx:idx++,
                    id:item.id,
                    name:item.name,
                    nameid:item.nameid,
                    desc:item.desc,
                    // tag:item.getTag()
                    tags:item.tags,
                    modules:item.modules,
                    noCVE:item.noCVE,
                }}),        
        });
    });
}

////////////////////////////////////////////////////////////////////
// MODULE EXPORT
////////////////////////////////////////////////////////////////////

module.exports.handleReq = handleReq;
module.exports.handlePost = handlePost;
module.exports.ROUTE_NAME = "projects";
