////////////////////////////////////////////////////////////////////
// MODULE LOADING
////////////////////////////////////////////////////////////////////

var ERR = require("../errno");
var TAGS = require("../controller/tags_ctrl");
const { markets } = require("../model/market");
var PROJECT_CTRL = require("../controller/project_ctrl");
var MODULE_CTRL = require("../controller/module_ctrl");
var APP = require("../app");


////////////////////////////////////////////////////////////////////
// GLOBAL VARIABLES
////////////////////////////////////////////////////////////////////

var log = require("../log").build("projects");


////////////////////////////////////////////////////////////////////
// FUNCTION
////////////////////////////////////////////////////////////////////

function handleReq(req, res, next){
    log.d("handleReq");
    var tags = TAGS.getTags();
    MODULE_CTRL.getList().then(items => {
        res.render('editprj', {
            tags:Object.keys(tags).map(function(key){
                return {
                    id:key,
                    name:tags[key]
                }
            }),
            modules:items.map(function(item){
                return {
                    id:item.id,
                    name:item.name,
                }
            }),
        });
    });
    
}

function handlePost(req, res, next){
    log.d("handlePost");
    
    
    PROJECT_CTRL.getListProjectsWithModule(function(errCode, items){
        log.d("search callback");
        var idx = 0;
        var tags = TAGS.getTags();
        TAGS.dumpTags(tags);
        res.json({
            startIdx:idx,
            tags:Object.keys(tags).map(function(key){
                return {
                    id:key,
                    name:tags[key]
                }
            }),
            projects:items.map(function(item){
                return {
                    idx:idx++,
                    id:item.id,
                    name:item.name,
                    nameid:item.nameid,
                    desc:item.desc,
                    // tag:item.getTag()
                    tags:item.tags,
                    modules:item.modules,
                    noCVE:item.noCVE,
                }}),        
        });
    });
}

////////////////////////////////////////////////////////////////////
// MODULE EXPORT
////////////////////////////////////////////////////////////////////

module.exports.handleReq = handleReq;
module.exports.handlePost = handlePost;
module.exports.ROUTE_NAME = "projects";
