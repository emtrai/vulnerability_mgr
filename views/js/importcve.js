const IMPORT_STATE_IDLE = 0;
const IMPORT_STATE_PREPARE = 1;
const IMPORT_STATE_PARSE = 2;
const IMPORT_STATE_DONE = 3;
const IMPORT_STATE_ERROR = -1;

const IMPORT_STATUS_STR = {
    [IMPORT_STATE_IDLE]:"Idle",
    [IMPORT_STATE_PREPARE]:"Prepare",
    [IMPORT_STATE_PARSE]:"Parsing",
    [IMPORT_STATE_DONE]:"Done",
    [IMPORT_STATE_ERROR]:"Error",
}


function updateStatus(msg){
    $("#status").empty().html(msg);
}

var importReqId = null;

function onSubmit(response, status, xhdr){
    log("onSubmit");
    // $("#status").empty().text(response);
    console.log(response);
    var reqStatus = response.status;
    var reqId = response.reqId;
    var statusStr = "Unknown";
    
    if (IMPORT_STATUS_STR.hasOwnProperty(reqStatus))
    {
        statusStr = IMPORT_STATUS_STR[reqStatus];
    } 
    var downloadLink = `<a href='importcve?id=${reqId}' target="_blank" rel="noopener noreferrer">${reqId}</a>`;
    updateStatus(`Import req ${downloadLink}: ${statusStr}`);
    importReqId = reqId;
    setTimeout(function(){
        queryImportReq(importReqId);
    }, 1000);
}
function onSubmitErr(request, status, error){
    log("onSubmitErr");
    // status('Error: ' + xhr.status);
    var msg = `${status}, ${error}, ${request.status}, ${request.responseText}`;
    updateStatus(msg);
    importReqId = null;
}

function onsumbit(){
    updateStatus("File is uploading...");
    $(this).ajaxSubmit({
        error: onSubmitErr,
        success: onSubmit
    });
    //Very important line, it disable the page refresh.
    return false;
}



function onQueryImportReq(response, status, xhdr){
    log("onQueryImportReq");
    console.log(response);
    var reqStatus = response.status;
    var reqId = response.reqId;
    var statusStr = "Unknown";
    
    if (IMPORT_STATUS_STR.hasOwnProperty(reqStatus))
    {
        statusStr = IMPORT_STATUS_STR[reqStatus];
    } 
    var downloadLink = `<a href='importcve?id=${reqId}' target="_blank" rel="noopener noreferrer">${reqId}</a>`;
    updateStatus(`Import req ${downloadLink}: ${statusStr}`);
    if ((reqStatus == IMPORT_STATE_PARSE) && (importReqId != null)){
        setTimeout(function(){
            queryImportReq(importReqId);
        }, 1000);
    }
    else{
        importReqId = null;

    }
    
}

function onQueryImportReqErr(request, status, error){
    log("onQueryImportReqErr");
    var msg = `${status}, ${error}, ${request.status}, ${request.responseText}`;
    updateStatus(msg);
    importReqId = null;
}



function queryImportReq(reqId){
    log("queryImportReq");
    var url = `/importcve?req=${reqId}`;
    $.ajax(url, {
        dataType:'json',
        type:'POST',
        success:onQueryImportReq,
        error: onQueryImportReqErr,
    })
}

function deselectAllPrj(){
    $("#opPrj").val([]);
}
const ID_DIV_MODULE_CONTAINER = '#divModule_container';
const ID_TXT_MODULES = '#txtModule';
function getModuleList(){
    var spantags = $(ID_DIV_MODULE_CONTAINER).find("span");
    var modules = [];
    $.each(spantags, function(idx, ele){
        modules.push(ele.innerText);
    });
    return modules;
}

jQuery(function(){
    $(document).on("keydown", ":input:not(textarea)", function(event) {
        return event.key != "Enter";
    });
    
    $(document).ready(function() {
        $('#uploadForm').submit(function(e) {
           $("#status").empty().text("File is uploading...");
           var formData = new FormData($('#uploadForm')[0]);
           e.preventDefault(); 
           
           formData.append('modules', getModuleList());

           $.ajax({
               url:'/importcve',
               type: 'POST',
               contentType: false,
               processData: false,
               cache: false,
               data: formData,
               success: onSubmit,
               error: onSubmitErr
           })

           //Very important line, it disable the page refresh.
       return false;
       });     
   });

   $(ID_TXT_MODULES).on(
    {
        focusout: function(){
            var tagstr = this.value.replace(/[^a-zA-Z0-9\_\+\-\#\.\:]/i, '');
            if (tagstr){
                $("<span/>", {
                    text:tagstr,
                    appendTo:ID_DIV_MODULE_CONTAINER,
                    class:"dashfolio-tag"
                });

            }
            this.value="";
        },
        keyup:function(ev){
            if (/188|13/.test(ev.which)) $(this).focusout();  
        }
    })

    $(ID_DIV_MODULE_CONTAINER).on('click', 'span', function() {
        $(this).remove(); 
    });
    
})
