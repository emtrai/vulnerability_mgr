
//key=xxx&in=xxx&

const PARAM_PAGE = 'page';
const PARAM_PERPAGE = 'perpage';
const PARAM_SEARCH_KEY = 'key';
const PARAM_SEARCH_IN = 'in'; // cve, module, project, etc.
const PARAM_FILTER_PRJ = 'prj'; // use with search in
const PARAM_FILTER_COMP = 'comp';
const PARAM_FILTER_MODULE = 'mod';
const PARAM_FILTER_MARKET = 'mrk';
const PARAM_FILTER_SRC = 'src';
const PARAM_FILTER_TAG = 'tag';
const PARAM_SEARCH_FIELD = 'field'; // i.e. id, moduleId, etc.

const ID_DIALOG_EDIT_MODULE = "#dlgEditModule";
const ID_TXT_MOD_NAME = "#txtModName";
const ID_TXT_MOD_VER = "#txtModVer";
const ID_TXT_CVEID = "#txtCVEID";

var paramlist=[
    PARAM_PAGE
    ,PARAM_PERPAGE
    ,PARAM_SEARCH_KEY
    ,PARAM_SEARCH_IN
    ,PARAM_FILTER_PRJ
    ,PARAM_FILTER_COMP
    ,PARAM_FILTER_MODULE
    ,PARAM_FILTER_MARKET
    ,PARAM_FILTER_SRC
    ,PARAM_FILTER_TAG
    ,PARAM_SEARCH_FIELD
];



function showHide(divid, hide){
    var div = document.getElementById(divid);
    if (div != null){
        div.style.display = hide?"none":"block";
    }
}
function showHideToggle(divid){
    var div = document.getElementById(divid);
    if (div != null){
        
        div.style.display = div.style.display=="block"?"none":"block";
    }
}

var query = false;
function doFilter(){
    var param = {
        "key":"CVE"
    };
    query = false
    var page = document.getElementById('perpage');
    param["perpage"] = page.value
    var url = queryCVE(param);
    if (url != null){

        window.history.pushState(param,"", url);
    }
}

function onLoadCVE(data, status, xhdr){
    var tbl = document.getElementById('tblCVE');
    var divPage = document.getElementById('divPage');
    var rowCount = tbl.rows.length;
	var cellCount = tbl.rows[0].cells.length; 
    if (data != null){
        // $.each
        divPage.innerHTML = `
        ${data.page}/${data.totalpages}
        `;
    }
    $.each( data.cves, function( index, value ) {
        // log(`${index}: ${value.desc}`);
        var row = tbl.insertRow(rowCount++);
        var cellidx = 0;
        row.insertCell(cellidx++).innerHTML = `<a href='cve?id=${value.id}' target="_blank" rel="noopener noreferrer">${value.idx}</a>`;
        row.insertCell(cellidx++).innerHTML =  `<a href='cve?id=${value.vul_number}' target="_blank" rel="noopener noreferrer">${value.vul_number}</a>`;
        row.insertCell(cellidx++).innerHTML =  `<a href='cve?id=${value.cve_number}' target="_blank" rel="noopener noreferrer">${value.cve_number}</a>`;
        desc_more = null;
        if (value.desc.length <= 200){

            row.insertCell(cellidx++).innerHTML = value.desc;
            desc_more = null;
        }
        else{
            row.insertCell(cellidx++).innerHTML = `${value.desc.substr(0, 200)}<span id="dots_${value.vul_number}">...</span><span id="more_${value.cve_number}" style='display:none'>${value.desc.substr(200)}</span><button  onclick="readmore('${value.vul_number}')" id="btnmore_${value.vul_number}" class="button_link">Read more</button>`;
        }
        

        row.insertCell(cellidx++).innerHTML = value.source;
        row.insertCell(cellidx++).innerHTML = value.ref;
        row.insertCell(cellidx++).innerHTML = value.tag;
        allmodule = ""
        // for (var key in value.module){
        //     module_val = key;
        //     version = value.module[key];
        //     if (version.length > 0){
        //         module_val += `(${version})`;
        //     }
        //     module = `<button  onclick="updateModule('${value.vul_number}', '${key}', '${version}')" id="btnmoduleedit_${value.vul_number}_${key}" class="button_link">${module_val}</button>`;
        //     module += `[<button  onclick="deleteModule('${value.vul_number}', '${key}')" id="btnmoduledel_${value.vul_number}_${key}" class="button_link">X</button>]`;
            
        //     allmodule += module;
        //     allmodule += "\n";
        // }
        // for (var key in value.module){
        // console.log(value.modules);
        value.modules.forEach(module=>{
            var module_val = module.moduleName;
            var version = module.moduleVersions;
            if (version.length > 0){
                module_val += `(${version})`;
            }
            var module_btn = `<button  onclick="updateModule('${value.vul_number}', '${module.moduleId}', '${version}')" id="btnmoduleedit_${value.vul_number}_${module.moduleId}" class="button_link">${module_val}</button>`;
            module_btn += `[<button  onclick="deleteModule('${value.vul_number}', '${module.moduleId}')" id="btnmoduledel_${value.vul_number}_${module.moduleId}" class="button_link">X</button>]`;
            
            allmodule += module_btn;
            allmodule += "\n";
        });
        allmodule += `<button  onclick="updateModule('${value.vul_number}', '', '', true)" id="btnmoduleadd_${value.vul_number}" class="button_link">Add</button>`;
        row.insertCell(cellidx++).innerHTML = allmodule;

        var allprj = "";
        console.log(value.projects);
        value.projects.forEach(prj=>{
            var prj_val = prj.projectName;
            var prjbtn = `<button  onclick="updateModule('${value.vul_number}', '${prj.projectId}')" id="btnmoduleedit_${value.vul_number}_${prj.projectId}" class="button_link">${prj_val}</button>`;
            prjbtn += `[<button  onclick="deleteModule('${value.vul_number}', '${prj.projectId}')" id="btnmoduledel_${value.vul_number}_${prj.projectId}" class="button_link">X</button>]`;
            
            allprj += prjbtn;
            allprj += "\n";
        });
        allprj += `<button  onclick="updateModule('${value.vul_number}', '', '', true)" id="btnmoduleadd_${value.vul_number}" class="button_link">Add</button>`;
        row.insertCell(cellidx++).innerHTML = allprj;

      });
    showHide('divFilter', true);
	// var row = tbl.insertRow(rowCount);
}
function updateModule(vul_number, name="", version="", add=false){
    var title = `${vul_number}: Edit module`;
    var action = "update";
    if (add){
        title = `${vul_number}: Add module`;
    }
 
    showEditDialog(title, action, vul_number, name, version);
}
function showEditDialog(title, action, vul_number, name, version){
    $(ID_DIALOG_EDIT_MODULE).dialog({
        title: title,
    });

    $(ID_TXT_MOD_NAME).val(name);
    $(ID_TXT_MOD_VER).val(version);
    $(ID_TXT_CVEID).val(vul_number);

    $(ID_DIALOG_EDIT_MODULE)
        .data("vul_number", vul_number)
        .data("name", name)
        .data("version", version)
        .data("action", action)
        .dialog("open");
}


function readmore(id) {
    var dots = document.getElementById(`dots_${id}`);
    var moreText = document.getElementById(`more_${id}`);
    var btnText = document.getElementById(`btnmore_${id}`);
  
    if (dots.style.display === "none") {
      dots.style.display = "inline";
      btnText.innerHTML = "Read more"; 
      moreText.style.display = "none";
    } else {
      dots.style.display = "none";
      btnText.innerHTML = "Read less"; 
      moreText.style.display = "inline";
    }
  }

function queryCVE(paramdic){
    log("QueryCVE");
    var param = "";
    // if (query == true)
    //     return null;
    // query = true;
    $.each(paramdic, function(key, value){
        if (param.length != 0){
            param += "&";
        }
        param += `${key}=${value}`;
    });
    
    if (param.length > 0){

        var url = `/list?${param}`;
        $.ajax(url, {
            dataType:'json',
            type:'POST',
            success:onLoadCVE
        })
        return url;
    }
    
    return null;
}

function submitUpdateModule(self, fromdialog = true){
    if (fromdialog){
        var vul_number = $(ID_DIALOG_EDIT_MODULE).data('vul_number');
        var name = $(ID_DIALOG_EDIT_MODULE).data('name');
        var version = $(ID_DIALOG_EDIT_MODULE).data('version');
        var action = $(ID_DIALOG_EDIT_MODULE).data('action');
        
        var newName = $(ID_TXT_MOD_NAME).val();
        var newVersion = $(ID_TXT_MOD_VER).val();

        if (action == "add"){
            confirm(`${vul_number} add ${newName}, ${newVersion}`);
        }
        else{
            confirm(`${vul_number} update ${name} (${version}) to ${newName} (${newVersion})`);
        }
    }
}

jQuery(function(){
    var url = new URL(window.location.href);

    var param = {};
    paramlist.forEach(function(element){
        var value = url.searchParams.get(element);
        if ((value != undefined) && (value != null) && (value.length != 0)){
            param[element] = value;
        }
    });
    log(param);
    if (Object.keys(param).length > 0)
        queryCVE(param);

    $( ID_DIALOG_EDIT_MODULE ).dialog({
        autoOpen: false,
        modal: true,
        buttons: {
          "Update": function() {
            $(ID_DIALOG_EDIT_MODULE).dialog( "close" );
            submitUpdateModule(this, true);
          },
          Cancel: function() {
            $(ID_DIALOG_EDIT_MODULE).dialog( "close" );
          }
        }
      });
    
})
// $(document).ready(function() {

//     var url = new URL(window.location.href);

//     var param = {};
//     paramlist.forEach(function(element){
//         var value = url.searchParams.get(element);
//         if ((value != undefined) && (value != null) && (value.length != 0)){
//             param[element] = value;
//             queryCVE(param);
//         }
//     });
//        //Very important line, it disable the page refresh.
//    return false;   
// });

// window.onpopstate = function(event){
//     if ((event.state != null) && (event.state != undefined)){
//         queryCVE(event.state);
     
//     }
// };
