
const ID_DIALOG_EDIT_MODULE = "#dlgEdit";
const ID_DIALOG_SPAN_INFO= "#dlgInfo";
const ID_SPAN_INFO="#spanInfo"
const ID_TXT_ID = "#txtID";
const ID_TXT_NAME = "#txtName";
const ID_TXT_DESC = "#txtDesc";
const ID_TXT_TAG = "#txtTag";
const ID_DIV_STATUS = "#divStatus";
const ID_TBL_PRJ = "#tblPrj";

const ACTION_ADD="add";
const ACTION_EDIT="adit";

function onLoadModule(data, status, xhdr){
    $(ID_DIV_STATUS).hide();
    $(ID_TBL_PRJ).show();
    var divPrjs = document.getElementById('divModules');
    var datalistTags = document.getElementById('opttags');
    var tbody = document.getElementById('tblBody');


    removeAllChildNodes(datalistTags);
    $.each( data.tags, function( index, value ) {
        log(value);
        var option = document.createElement('option');
        option.value = value.name;
        datalistTags.appendChild(option);
        // datalistTags.appendChild("<option value='"+value.name+"'></option>");
    });


    removeAllChildNodes(tbody);

    var rowCount = tbody.rows.length;

    var cellidx = 0;

    rowCount = 0;
    $.each( data.modules, function( index, value ) {
        // log(`${index}: ${value.name}`);
        var row = tbody.insertRow(rowCount++);
        cellidx = 0;
        // log(value);
        row.insertCell(cellidx++).innerHTML = value.idx;
        row.insertCell(cellidx++).innerHTML = value.id;
        // row.insertCell(cellidx++).innerHTML = value.nameid;
        row.insertCell(cellidx++).innerHTML = value.name;
        row.insertCell(cellidx++).innerHTML = value.desc;
        var alltags = "";
        
        for (var idx in value.tags){
            var tag = value.tags[idx];
            alltags += `${tag} [<button  onclick="deleteTag('${value.id}', '${tag}')" id="btnmoduledel_${value.id}" class="button_link">X</button>]`;
   
            alltags += "\n";
        }
        alltags += `<button  onclick="addTag('${value.id}', '', '', true)" id="btnmoduleadd_${value.id}" class="button_link">Add</button>`;
        
        row.insertCell(cellidx++).innerHTML = alltags;

        alltags = "";
        for (var idx in value.versions){
            var version = value.versions[idx];
            alltags += `${version} [<button  onclick="deleteTag('${value.id}', '${version}')" id="btnmoduledel_${value.id}" class="button_link">X</button>]`;
   
            alltags += "\n";
        }
        alltags += `<button  onclick="addTag('${value.id}', '', '', true)" id="btnmoduleadd_${value.id}" class="button_link">Add</button>`;
        

        row.insertCell(cellidx++).innerHTML = alltags;

        alltags = "";
        
        
        for (var idx in value.projects){
            var prj = value.projects[idx];
            log("PROJECT");
            log(prj);
            alltags += `<a href='list?cond=${prj.projectId}|prj|id&cond=${value.id}|mod|id' target="_blank" rel="noopener noreferrer">${prj.projectName}</a> [<button  onclick="deleteTag('${prj.projectId}', '${prj.projectName}')" id="btnmoduledel_${value.id}" class="button_link">X</button>]`;
   
            alltags += "\n";
        }
        alltags += `<button  onclick="addTag('${value.id}', '', '', true)" id="btnmoduleadd_${value.id}" class="button_link">Add</button>`;
        

        row.insertCell(cellidx++).innerHTML = alltags;

        if (value.noCVE > 0)
            row.insertCell(cellidx++).innerHTML = `<a href='list?cond=${value.id}|mod|id' target="_blank" rel="noopener noreferrer">${value.noCVE}</a>`;
        else{
            row.insertCell(cellidx++).innerHTML = "-";
        }
      });
}
function addTag(id, tagname=""){
    // var title = `${vul_number}: Edit module`;
    // var action = "update";
    // if (add){
    //     title = `${vul_number}: Add module`;
    // }
 
    // showEditDialog(title, action, vul_number, name, version);
}

function add_project(){
    $(ID_DIALOG_EDIT_MODULE).dialog({
        title: "Add Project",
    });
    $(ID_TXT_ID).val("");
    $(ID_TXT_NAME).val("");
    $(ID_TXT_DESC).val("");
    $(ID_TXT_TAG).val("");

    $(ID_DIALOG_EDIT_MODULE)
        .data("action", ACTION_ADD)
        .dialog("open");
}
function edit_project(prj){
    $(ID_DIALOG_EDIT_MODULE).dialog({
        title: "Edit project",
    });

    $(ID_TXT_ID).val(prj.id);
    $(ID_TXT_NAME).val(prj.name);
    $(ID_TXT_DESC).val(prj.desc);
    $(ID_TXT_TAG).val(prj.tag);
    $(ID_DIALOG_EDIT_MODULE)
        .data("prj", prj)
        .data("action", action)
        .dialog("open");
}



function loadModuleList(){
    log("loadModuleList");
    $(ID_DIV_STATUS).show();
    $(ID_TBL_PRJ).hide();
    var url = `/modules`;
    $.ajax(url, {
        dataType:'json',
        type:'POST',
        success:onLoadModule
    })
    return url;
}

function onSubmitSuccess(data){
    showInfo(data.msg, true);
    loadModuleList();
}
function onSubmitErr(request, status, error){
    var msg = `${status}, ${error}, ${request.status}, ${request.responseText}`;
    showInfo(msg, true);
}

function submitUpdateModule(self, fromdialog = true){
    if (fromdialog){
        var prj = $(ID_DIALOG_EDIT_MODULE).data('prj');
        var action = $(ID_DIALOG_EDIT_MODULE).data('action');
        
        var id = $(ID_TXT_ID).val();
        var name = $(ID_TXT_NAME).val();
        var desc = $(ID_TXT_DESC).val();
        var tags = $(ID_TXT_TAG).val();
        var data = {
            name:name,
            desc:desc,
            tags:tags,
        }
        if (action == "add"){
            showInfo(`Adding project '${name}'`);
        }
        else if (action == "update"){
            data.push(id, id);
            showInfo(`Updating '${id} - ${name}`);
        }
        else{
            showInfo(`Updating project failed, invalid ${action}`);
            return;
        }
        log(`Submit ${JSON.stringify (data)}`);
        $.ajax({
            type: 'POST',
            url: `/prj?req=${action}`,
            data: JSON.stringify (data) ,
            success: onSubmitSuccess,
            error: onSubmitErr,
            contentType: "application/json",
            dataType: 'json'
        });
    }
}

function showInfo(html, allowClose=false){
    if (allowClose){
        $( ID_DIALOG_SPAN_INFO ).dialog({
            buttons: [
              {
                text: "Close",
                click: function() {
                  $( this ).dialog( "close" );
                }
              }
            ]
          });
    }
    else{
        $( ID_DIALOG_SPAN_INFO ).dialog({
            buttons: null
          });
    }
    $(ID_SPAN_INFO).html(html);
    $(ID_DIALOG_SPAN_INFO).dialog("open");
}
function hideInfo(){
    $(ID_DIALOG_SPAN_INFO)
    .dialog("close");
}

jQuery(function(){
    loadModuleList();
    $( ID_DIALOG_EDIT_MODULE ).dialog({
        autoOpen: false,
        modal: true,
        buttons: {
          "Update": function() {
            $(ID_DIALOG_EDIT_MODULE).dialog( "close" );
            submitUpdateModule(this, true);
          },
          Cancel: function() {
            $(ID_DIALOG_EDIT_MODULE).dialog( "close" );
          }
        }
      });
      $( ID_DIALOG_SPAN_INFO ).dialog({
        autoOpen: false,
        height: "auto",
        width: "auto",
        modal: true,
        draggable: false,
        // dialogClass: "no-close",
        dialogClass: "no-titlebar",
      });
})
