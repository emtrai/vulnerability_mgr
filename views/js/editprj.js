
const ID_DIALOG_EDIT_MODULE = "#dlgEditPrj";
const ID_DIALOG_SPAN_INFO= "#dlgInfo";
const ID_SPAN_INFO="#spanInfo"
const ID_TXT_ID = "#txtID";
const ID_TXT_NAME = "#txtName";
const ID_TXT_DESC = "#txtDesc";
const ID_TXT_TAG = "#txtTag";
const ID_TXT_MODULES = "#txtModule";
const ID_DIV_STATUS = "#divStatus";
const ID_TBL_PRJ = "#tblPrj";
const ID_DIV_MODULE_CONTAINER = "#divModule_container";
const ID_DIV_TAG_CONTAINER = "#divTag_container";

const ACTION_ADD="add";
const ACTION_EDIT="adit";

function onLoadProject(data, status, xhdr){
    log("onLoadProject");
    $(ID_DIV_STATUS).hide();
    $(ID_TBL_PRJ).show();
    var divPrjs = document.getElementById('divPrjs');
    var datalistTags = document.getElementById('opttags');
    var table = document.getElementById('tblPrj');
    var tbody = document.getElementById('tblPrjBody');


    removeAllChildNodes(datalistTags);
    $.each( data.tags, function( index, value ) {
        log(value);
        var option = document.createElement('option');
        option.value = value.name;
        datalistTags.appendChild(option);
        // datalistTags.appendChild("<option value='"+value.name+"'></option>");
    });


    removeAllChildNodes(tbody);

    var rowCount = tbody.rows.length;

    var cellidx = 0;

    rowCount = 0;
    $.each( data.projects, function( index, value ) {
        log(`${index}: ${value.name}`);
        var row = tbody.insertRow(rowCount++);
        cellidx = 0;
        log(value);
        row.insertCell(cellidx++).innerHTML = value.idx;
        row.insertCell(cellidx++).innerHTML = value.id;
        // row.insertCell(cellidx++).innerHTML = value.nameid;
        row.insertCell(cellidx++).innerHTML = value.name;
        row.insertCell(cellidx++).innerHTML = value.desc;
        var alltags = "";
        
        for (var idx in value.tags){
            tag = value.tags[idx];
            alltags += `${tag} [<button  onclick="deleteTag('${value.id}', '${tag}')" id="btnmoduledel_${value.id}" class="button_link">X</button>]`;
   
            alltags += "\n";
        }
        alltags += `<button  onclick="addTag('${value.id}', '', '', true)" id="btnmoduleadd_${value.id}" class="button_link">Add</button>`;
        

        row.insertCell(cellidx++).innerHTML = alltags;

        alltags = "";
        
        for (var idx in value.modules){
            var module = value.modules[idx];
            alltags += `<a href='list?cond=${module.moduleId}|mod|id&cond=${value.id}|prj|id' target="_blank" rel="noopener noreferrer">${module.moduleName}</a> [<button  onclick="deleteTag('${module.moduleId}', '${module.moduleName}')" id="btnmoduledel_${value.id}" class="button_link">X</button>]`;
   
            alltags += "\n";
        }
        alltags += `<button  onclick="addTag('${value.id}', '', '', true)" id="btnmoduleadd_${value.id}" class="button_link">Add</button>`;
        

        row.insertCell(cellidx++).innerHTML = alltags;
        row.insertCell(cellidx++).innerHTML = `<a href='list?cond=${value.id}|prj|id' target="_blank" rel="noopener noreferrer">${value.noCVE}</a>`;
      });
}
function addTag(id, tagname=""){
    // var title = `${vul_number}: Edit module`;
    // var action = "update";
    // if (add){
    //     title = `${vul_number}: Add module`;
    // }
 
    // showEditDialog(title, action, vul_number, name, version);
}

function add_project(){
    $(ID_DIALOG_EDIT_MODULE).dialog({
        title: "Add Project",
    });
    $(ID_TXT_ID).val("");
    $(ID_TXT_NAME).val("");
    $(ID_TXT_DESC).val("");
    $(ID_TXT_TAG).val("");
    $(ID_DIV_TAG_CONTAINER).empty();
    $(ID_DIV_MODULE_CONTAINER).empty();

    $(ID_DIALOG_EDIT_MODULE)
        .data("action", ACTION_ADD)
        .dialog("open");
}
function edit_project(prj){
    $(ID_DIALOG_EDIT_MODULE).dialog({
        title: "Edit project",
    });

    $(ID_TXT_ID).val(prj.id);
    $(ID_TXT_NAME).val(prj.name);
    $(ID_TXT_DESC).val(prj.desc);
    $(ID_TXT_TAG).val(prj.tag);
    $(ID_DIV_TAG_CONTAINER).empty();
    $(ID_DIV_MODULE_CONTAINER).empty();
    $(ID_DIALOG_EDIT_MODULE)
        .data("prj", prj)
        .data("action", action)
        .dialog("open");
}



function loadProjectList(){
    log("loadProjectList");
    $(ID_DIV_STATUS).show();
    $(ID_TBL_PRJ).hide();
    var url = `/projects`;
    $.ajax(url, {
        dataType:'json',
        type:'POST',
        success:onLoadProject
    })
    return url;
}

function onSubmitSuccess(data){
    showInfo(data.msg, true);
    loadProjectList();
}
function onSubmitErr(request, status, error){
    var msg = `${status}, ${error}, ${request.status}, ${request.responseText}`;
    showInfo(msg, true);
}
function getTags(ele){
    var spantags = $(ele).find("span");
    var tags = [];
    $.each(spantags, function(idx, ele){
        tags.push(ele.innerText);
    });
    return tags;
}

function submitUpdateModule(self, fromdialog = true){
    if (fromdialog){
        var prj = $(ID_DIALOG_EDIT_MODULE).data('prj');
        var action = $(ID_DIALOG_EDIT_MODULE).data('action');
        
        var id = $(ID_TXT_ID).val();
        var name = $(ID_TXT_NAME).val();
        var desc = $(ID_TXT_DESC).val();
        // var tags = $(ID_TXT_TAG).val();
        var tags = getTags(ID_DIV_TAG_CONTAINER);
        var modules = getTags(ID_DIV_MODULE_CONTAINER);
        var data = {
            name:name,
            desc:desc,
            tags:tags,
            modules:modules,
        }
        // var spantags = $(ID_DIV_TAG_CONTAINER).find("span");
        // $.each(spantags, function(idx, ele){
        //    log(ele.innerText);
        // });
        if (action == "add"){
            showInfo(`Adding project '${name}'`);
        }
        else if (action == "update"){
            data.push(id, id);
            showInfo(`Updating '${id} - ${name}`);
        }
        else{
            showInfo(`Updating project failed, invalid ${action}`);
            return;
        }
        log(`Submit ${JSON.stringify (data)}`);
        $.ajax({
            type: 'POST',
            url: `/prj?req=${action}`,
            data: JSON.stringify (data) ,
            success: onSubmitSuccess,
            error: onSubmitErr,
            contentType: "application/json",
            dataType: 'json'
        });
    }
}

function showInfo(html, allowClose=false){
    if (allowClose){
        $( ID_DIALOG_SPAN_INFO ).dialog({
            buttons: [
              {
                text: "Close",
                click: function() {
                  $( this ).dialog( "close" );
                }
              }
            ]
          });
    }
    else{
        $( ID_DIALOG_SPAN_INFO ).dialog({
            buttons: null
          });
    }
    $(ID_SPAN_INFO).html(html);
    $(ID_DIALOG_SPAN_INFO).dialog("open");
}
function hideInfo(){
    $(ID_DIALOG_SPAN_INFO)
    .dialog("close");
}

function init(){
    $(ID_TXT_MODULES).on(
        {
            focusout: function(){
                var tagstr = this.value.replace(/[^a-zA-Z0-9\_\+\-\#\.\:]/i, '');
                if (tagstr){
                    $("<span/>", {
                        text:tagstr,
                        appendTo:ID_DIV_MODULE_CONTAINER,
                        class:"dashfolio-tag"
                    });

                }
                this.value="";
            },
            keyup:function(ev){
                if (/188|13/.test(ev.which)) $(this).focusout();  
            }
        }
    )

    $(ID_DIV_MODULE_CONTAINER).on('click', 'span', function() {
        $(this).remove(); 
    });

    $(ID_TXT_TAG).on(
        {
            focusout: function(){
                var tagstr = this.value.replace(/[^a-zA-Z0-9\_\+\-\#\.]/i, '');
                if (tagstr){
                    $("<span/>", {
                        text:tagstr,
                        appendTo:ID_DIV_TAG_CONTAINER,
                        class:"dashfolio-tag"
                    });

                }
                this.value="";
            },
            keyup:function(ev){
                if (/188|13/.test(ev.which)) $(this).focusout();  
            }
        }
    )
    $(ID_DIV_TAG_CONTAINER).on('click', 'span', function() {
        $(this).remove(); 
    });
}

jQuery(function(){
    init();
    loadProjectList();
    $( ID_DIALOG_EDIT_MODULE ).dialog({
        autoOpen: false,
        modal: true,
        buttons: {
          "Update": function() {
            $(ID_DIALOG_EDIT_MODULE).dialog( "close" );
            submitUpdateModule(this, true);
          },
          Cancel: function() {
            $(ID_DIALOG_EDIT_MODULE).dialog( "close" );
          }
        }
      });
      $( ID_DIALOG_SPAN_INFO ).dialog({
        autoOpen: false,
        height: "auto",
        width: "auto",
        modal: true,
        draggable: false,
        // dialogClass: "no-close",
        dialogClass: "no-titlebar",
      });
})
