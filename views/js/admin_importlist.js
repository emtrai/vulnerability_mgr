const IMPORT_STATE_IDLE = 0;
const IMPORT_STATE_PREPARE = 1;
const IMPORT_STATE_PARSE = 2;
const IMPORT_STATE_DONE = 3;
const IMPORT_STATE_ERROR = -1;


const IMPORT_STATUS_STR = {
    [IMPORT_STATE_IDLE]:"Idle",
    [IMPORT_STATE_PREPARE]:"Prepare",
    [IMPORT_STATE_PARSE]:"Parsing",
    [IMPORT_STATE_DONE]:"Done",
    [IMPORT_STATE_ERROR]:"Error",
}


function onLoadImportList(data, status, xhdr){
    log("onLoadProject");
    
    var divImport = document.getElementById('divImport');
    
    var table = document.getElementById('tblList');
    var tbody = document.getElementById('tblListBody');

    
    removeAllChildNodes(tbody);

    var rowCount = tbody.rows.length;

    var cellidx = 0;
    var idx = 0;

    rowCount = 0;
    $.each( data.items, function( index, value ) {
        log(`${index}: ${value.name}`);
        var row = tbody.insertRow(rowCount++);
        cellidx = 0;
        
        row.insertCell(cellidx++).innerHTML = ++idx;
        row.insertCell(cellidx++).innerHTML = `<a href='importcve?id=${value.importId}' target="_blank" rel="noopener noreferrer">${value.importId}</a>`;
        
        row.insertCell(cellidx++).innerHTML = value.title;
        row.insertCell(cellidx++).innerHTML = value.source;
        var statusStr = value.importStatus;
    
        if (IMPORT_STATUS_STR.hasOwnProperty(value.importStatus))
        {
            statusStr = IMPORT_STATUS_STR[value.importStatus];
        } 

        row.insertCell(cellidx++).innerHTML = statusStr;

        row.insertCell(cellidx++).innerHTML = value.importResult;
        
        
        
        
        row.insertCell(cellidx++).innerHTML =  value.added > 0?`<a href='list?cond=${value.importId}|import|' target="_blank" rel="noopener noreferrer">${value.added}</a>`:"-";

        row.insertCell(cellidx++).innerHTML = value.skipped > 0?value.skipped:"-";
        row.insertCell(cellidx++).innerHTML = (new Date(value.createDate)).toISOString();

        row.insertCell(cellidx++).innerHTML = `<button  onclick="deleteModule('${value.id}', '${value.importId}')" class="button_link">Delete</button>`;

      });
}




function deleteModule(id, importId){
    // $.ajax({
    //     type: 'POST',
    //     url: `/importcve?req=del`,
    //     data: JSON.stringify (data) ,
    //     success: onSubmitSuccess,
    //     error: onSubmitErr,
    //     contentType: "application/json",
    //     dataType: 'json'
    // });
}


function loadImportList(){
    log("loadImportList");
    
    var url = `/importlist`;
    $.ajax(url, {
        dataType:'json',
        type:'POST',
        success:onLoadImportList
    })
    return url;
}



jQuery(function(){
    loadImportList();
    
})
