
//key=xxx&in=xxx&


const PARAM_SEARCH_CONDITION = 'cond';
const PARAM_PAGE = 'page';



var paramlist=[
    ,PARAM_SEARCH_CONDITION
    ,PARAM_PAGE
];

const ID_TXT_KEYWORD = "#textKeyword";
const ID_SELECT_SEARCH_IN="#searchIn";
const ID_SELECT_SEARCH_FIELD="#searchField";
const ID_SELECT_FILTER_PROJECT="#filterProject";
const ID_SELECT_FILTER_MODULE="#filterModule";
const ID_DIV_SEARCH_INFO="#divSearchInfo";

function showHide(divid, hide){
    var div = document.getElementById(divid);
    if (div != null){
        div.style.display = hide?"none":"block";
    }
}
function showHideToggle(divid){
    var div = document.getElementById(divid);
    if (div != null){
        
        div.style.display = div.style.display=="block"?"none":"block";
    }
}

var query = false;
function doFilter(){
    var param = {};
    query = false
    log("doFilter");
    // var page = document.getElementById('perpage');
    // param["perpage"] = page.value
    var keyword = $(ID_TXT_KEYWORD).val();
    var prj = $(ID_SELECT_FILTER_PROJECT).val();
    var module = $(ID_SELECT_FILTER_MODULE).val();
    
    var cond = [];
    if ((keyword != null) && (keyword != undefined) && (keyword != "")){
        cond.push(`${keyword}|cve|`);
    }

    if ((prj != null) && (prj != undefined) && (prj != "")){
        if (prj != "any")
        {
            cond.push(`${prj}|prj|id`);
        }
    }
    if ((module != null) && (module != undefined) && (module != "")){
        if (module != "any")
        {
            cond.push(`${module}|mod|id`);
        }
    }
    if (cond.length > 0){
        param[PARAM_SEARCH_CONDITION] = cond;
    }
    var url = queryCVE(param);
    if (url != null){

        window.history.pushState(param,"", url);
    }
}


// function doSearch(){
//     var param = {};
//     query = false
//     log("doFilter");
//     // var page = document.getElementById('perpage');
//     // param["perpage"] = page.value
//     var keyword = $(ID_TXT_KEYWORD).val();
//     var searchIn = $(ID_SELECT_SEARCH_IN).val();
//     var searchField = $(ID_SELECT_SEARCH_FIELD).val();
//     var cond = "";
//     if ((keyword != null) && (keyword != undefined) && (keyword != "") && (keyword.trim() != "")){
//         cond = keyword;
//     }
//     cond += "|";
//     if ((searchIn != null) && (searchIn != undefined) && (searchIn != "")){
        
//         if (searchIn != "any")
//         {
//             cond += searchIn;
//         }
//     }
//     cond += "|";
//     if ((searchField != null) && (searchField != undefined) && (searchField != "")){
        
//         if (searchField != "any")
//         {
//             cond += searchField;
//         }
//     }
//     if (cond.length > 0){
//         param[PARAM_SEARCH_CONDITION] = [cond];
//     }
//     var url = queryCVE(param);
//     if (url != null){

//         window.history.pushState(param,"", url);
//     }
// }

function urlFromDic(paramdic){
    var param = "";
    log(paramdic);
    // if (query == true)
    //     return null;
    // query = true;
    $.each(paramdic, function(key, value){
        $.each(value, function(idx, item){
            if (param.length != 0){
                param += "&";
            }
            param += `${key}=${item}`;
        })
        // param += `${key}=${value}`;
    });
    // log(param);
    var parString = "";
    if (param.length > 0){
        parString = `?${param}`;
    }

    var url = `/list${parString}`;
    return url;
}

function buildPages(page, totalpages, total){

    var pagehtml = "";
    if (totalpages > 0){
        var next = "[Next]";
        var back = "[Back]";
        var paramdic={};
        var url = new URL(window.location.href);
        var value = url.searchParams.getAll(PARAM_SEARCH_CONDITION);
        if ((value != undefined) && (value != null) && (value.length != 0)){
            paramdic[PARAM_SEARCH_CONDITION] = value;
        }
        var paramdiclength = Object.keys(paramdic).length;
        var relurl = urlFromDic(paramdic);

        if (page > 1){
            // var backpage = `page=${page-1}`;
            // if (paramdic.length >)
            back = `<a href='${relurl}${paramdiclength > 0?"&":"?"}page=${page-1}'>[Back]</a>`;
        }
        
        if (page < totalpages){
            next = `<a href='${relurl}${paramdiclength > 0?"&":"?"}page=${page+1}'>[Next]</a>`;
        }
    
        pagehtml = `${back} page ${page}/${totalpages} ${next}`;
    }
   

    return  `${pagehtml} Total: ${total} item(s)`;
}

function onLoadCVE(data, status, xhdr){
    var tbl = document.getElementById('tblCVE');
    var tblBody = document.getElementById('tbodyCVE');
    var divPage = document.getElementById('divPage');
    // var divPage = document.getElementById('divPage');
	var cellCount = tbl.rows[0].cells.length; 
    if (data != null){
        // $.each
        // divPage.innerHTML = `
        // ${data.page}/${data.totalpages}
        // `;
        divPage.innerHTML = buildPages(parseInt(data.page), parseInt(data.totalpages), parseInt(data.total));
    }
    removeAllChildNodes(tblBody);
    var rowCount = 0;
    $.each( data.cves, function( index, value ) {
        // log(`${index}: ${value.desc}`);
        var row = tblBody.insertRow(rowCount++);
        var cellidx = 0;
        row.insertCell(cellidx++).innerHTML = `<a href='cve?id=${value.id}' target="_blank" rel="noopener noreferrer">${value.idx}</a>`;
        row.insertCell(cellidx++).innerHTML =  `<a href='cve?id=${value.vul_id}' target="_blank" rel="noopener noreferrer">${value.vul_id}</a>`;
        row.insertCell(cellidx++).innerHTML =  `<a href='cve?id=${value.cve_id}' target="_blank" rel="noopener noreferrer">${value.cve_id}</a>`;
        desc_more = null;
        if (value.desc.length <= 200){

            row.insertCell(cellidx++).innerHTML = value.desc;
            desc_more = null;
        }
        else{
            row.insertCell(cellidx++).innerHTML = `${value.desc.substr(0, 200)}<span id="dots_${value.vul_id}">...</span><span id="more_${value.cve_id}" style='display:none'>${value.desc.substr(200)}</span><button  onclick="readmore('${value.vul_id}')" id="btnmore_${value.vul_id}" class="button_link">Read more</button>`;
        }
        

        row.insertCell(cellidx++).innerHTML = value.source;
        row.insertCell(cellidx++).innerHTML = value.ref;
        // row.insertCell(cellidx++).innerHTML = value.tag;
        allmodule = ""

        value.tags.forEach(tag=>{
           
            // var module_btn = `<a href='list?key=${module.moduleId}&in=mod&field=id' target="_blank" rel="noopener noreferrer">${module_val}</a>`;
            var module_btn = `<a href='list?cond=${tag}|cve|' target="_blank" rel="noopener noreferrer">${tag}</a>`;

            allmodule += module_btn;
            allmodule += "\n";
        });

        row.insertCell(cellidx++).innerHTML = allmodule;
        allmodule = ""

        value.modules.forEach(module=>{
            var module_val = module.moduleName;
            var version = module.moduleVersions;
            if (version.length > 0){
                module_val += `(${version})`;
            }
            
            // var module_btn = `<a href='list?key=${module.moduleId}&in=mod&field=id' target="_blank" rel="noopener noreferrer">${module_val}</a>`;
            var module_btn = `<a href='list?cond=${module.moduleId}|mod|id' target="_blank" rel="noopener noreferrer">${module_val}</a>`;

            allmodule += module_btn;
            allmodule += "\n";
        });
     
        row.insertCell(cellidx++).innerHTML = allmodule;

        var allprj = "";
        console.log(value.projects);
        value.projects.forEach(prj=>{
            var prj_val = prj.projectName;
            var prjbtn = `<a href='list?cond=${prj.projectId}|prj|id' target="_blank" rel="noopener noreferrer">${prj_val}</a>`;

            allprj += prjbtn;
            allprj += "\n";
        });
       
        row.insertCell(cellidx++).innerHTML = allprj;

      });
    showHide('divFilter', true);
    
}


function readmore(id) {
    var dots = document.getElementById(`dots_${id}`);
    var moreText = document.getElementById(`more_${id}`);
    var btnText = document.getElementById(`btnmore_${id}`);
  
    if (dots.style.display === "none") {
      dots.style.display = "inline";
      btnText.innerHTML = "Read more"; 
      moreText.style.display = "none";
    } else {
      dots.style.display = "none";
      btnText.innerHTML = "Read less"; 
      moreText.style.display = "inline";
    }
  }

function queryCVE(paramdic){
    log("QueryCVE");

    var url = urlFromDic(paramdic);
    $.ajax(url, {
        dataType:'json',
        type:'POST',
        success:onLoadCVE
    })
    return url;
    // }
    
}


jQuery(function(){
    var url = new URL(window.location.href);

    var param = {};
    paramlist.forEach(function(element){
        var value = url.searchParams.getAll(element);
        if ((value != undefined) && (value != null) && (value.length != 0)){
            param[element] = value;
        }
    });
    log(param);
    // if (Object.keys(param).length > 0)
    queryCVE(param);

        
    
})
// $(document).ready(function() {

//     var url = new URL(window.location.href);

//     var param = {};
//     paramlist.forEach(function(element){
//         var value = url.searchParams.get(element);
//         if ((value != undefined) && (value != null) && (value.length != 0)){
//             param[element] = value;
//             queryCVE(param);
//         }
//     });
//        //Very important line, it disable the page refresh.
//    return false;   
// });

// window.onpopstate = function(event){
//     if ((event.state != null) && (event.state != undefined)){
//         queryCVE(event.state);
     
//     }
// };
