// var http = require('http');
var CONFIG = require('./config').Config;

var import_cve = require('./www/importcve.js');

var list_www = require('./www/viewlist.js');
var admin_www = require('./www/admin.js');
var addprj_www = require('./www/addprj.js');
var multer  =  require('multer');
var ModDB = require('./db/db');

// var fs = require('fs');
var express = require('express');
var app = express()
app.set('port', process.env.PORT || CONFIG.PORT);

var handlebars = require('express3-handlebars').create({
    defaultLayout:'main',
    helpers: {
        section: function(name, options){
            if(!this._sections) this._sections = {};
            this._sections[name] = options.fn(this);
            return null;
        },
        copyrightYear: function() {
            return new Date().getFullYear();
        },
        version: function() {
            return "1.0";
        },
    }
});

var storage =   multer.diskStorage({
    destination: function (req, file, callback) {
      callback(null, './.data/.upload');
    },
    filename: function (req, file, callback) {
      callback(null, file.fieldname + '-' + Date.now());
    }
  });
  
var upload = multer({ storage : storage});

module.exports.uploadfile = function(req, res, name, func){
    upload.single(name)(req, res, func);
};

app.engine('handlebars', handlebars.engine);
app.set('view engine', 'handlebars')
app.use(express.static(__dirname + '/public'));

app.get("/", function(req, res){
    // res.send("Hello")
    res.render('home', {
        title: 'HOME'
    })
});

app.get("/about", function(req, res){
    // res.send("Hello")
    res.render('about');
});


app.get("/importcve", function(req, res){
    import_cve.handleReq(app, req, res);
});

app.post("/importcve", function(req, res){
    import_cve.handlePostReq(app, req, res);
});

app.get("/list", function(req, res){
    list_www.handleReq(app, req, res);
});
app.post("/list", function(req, res){
    list_www.handlePost(app, req, res);
});

app.get("/admin", function(req, res){
    admin_www.handleReq(app, req, res);
});
app.get("/addprj", function(req, res){
    addprj_www.handleReq(app, req, res);
});


// custom 404 page
app.use(function(req, res){
    res.status(404);
    res.render('404');

});

// custom 500 page
app.use(function(err, req, res, next){
    console.error(err.stack);
    res.type('text/plain');
    res.status(500);
    res.send('500 - Server Error');
});

ModDB.initDB();

app.listen(app.get('port'), function(){
    console.log( 'Express started on http://localhost:' +
    app.get('port') + '; press Ctrl-C to terminate.' );
});



// function serveStaticFile(res, path, contentType, responseCode) {
//     if(!responseCode) responseCode = 200;
//         fs.readFile(__dirname + path, function(err,data) {
//             if(err) {
//                 res.writeHead(500, { 'Content-Type': 'text/plain' });
//                 res.end('500 - Internal Error');
//             } else {
//                 res.writeHead(responseCode,
//                 { 'Content-Type': contentType });
//                 res.end(data);
//             }
//         });
//     }

// function main(){
//     http.createServer(function(req,res){
//         // normalize url by removing querystring, optional
//         // trailing slash, and making lowercase
//         var path = req.url.replace(/\/?(?:\?.*)?$/, '')
//             .toLowerCase();
//         switch(path) {
//             case '':
//             case '/index':
//             case '/home':
//                 serveStaticFile(res, '/public/html/index.html', 'text/html');
//                 break;
//             default:
//                 serveStaticFile(res, '/public/html/404.html', 'text/html',
//                 404);
//                 break;
//         }
//     }).listen(CONFIG.PORT);


//     console.log('Server started on localhost:' + CONFIG.PORT + '; press Ctrl-C to terminate....');
// }

// main();

